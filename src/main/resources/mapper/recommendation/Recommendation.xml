<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sandbox.apricot.recommendation.mapper.RecommendationMapper">
  <resultMap id="DistrictScoreResultMap" type="DistrictScoreDTO">
    <result property="districtCode" column="DISTRICT_CODE"/>
    <result property="districtScore" column="DISTRICT_SCORE"/>
  </resultMap>
  <select id="findAllDistrictScoreFromPolicyNumberByMemberId" resultMap="DistrictScoreResultMap">
    SELECT y.district_code, SUM(CASE i.priority WHEN 1 THEN 5
                                                WHEN 2 THEN 3
                                                WHEN 3 THEN 2
                                                ELSE 0 END) AS DISTRICT_SCORE
    FROM INTERESTS i
           JOIN YOUTH_POLICY_DETAIL y ON i.CATEGORY_ID = y.CATEGORY_CODE
    WHERE i.MEMBER_ID = #{memberId}
      AND DISTRICT_CODE != '26'
    GROUP BY y.DISTRICT_CODE
    ORDER BY DISTRICT_CODE
  </select>
  <select id="findAllDistrictScoreFromPolicyReputationByMemberId" resultMap="DistrictScoreResultMap">
    SELECT de.DISTRICT_CODE,                                      -- 지역 코드
           SUM(de.AVG_SCORE * (CASE i.PRIORITY
                                 WHEN 1 THEN 1.5
                                 WHEN 2 THEN 1.2
                                 WHEN 3 THEN 1.1
                                 ELSE 1 END)) AS DISTRICT_SCORE -- 총점에 가중치를 곱한 값의 합계
    FROM DISTRICT_EVALUATION de
           JOIN INTERESTS i ON de.CATEGORY_CODE = i.CATEGORY_ID
    WHERE i.MEMBER_ID = #{memberId} and DISTRICT_CODE != '26'
    GROUP BY de.DISTRICT_CODE
    ORDER BY DISTRICT_CODE
  </select>
</mapper>
